# Andy-LLM 训练文档

## 1. 模型架构

### 1.1 整体架构
- 基于 Transformer Decoder-only 架构
- 采用自回归语言模型设计
- 支持三种规模配置：tiny、small、medium

### 1.2 核心组件
1. **位置编码**
   - 使用正弦余弦位置编码
   - 支持最大序列长度为512
   - 位置编码维度与模型维度相同

2. **自注意力层**
   - 使用因果注意力掩码
   - 支持多头注意力机制
   - tiny: 2头
   - small: 4头
   - medium: 8头

3. **前馈网络**
   - 两层线性变换
   - 中间层维度是模型维度的4倍
   - 使用 GELU 激活函数

## 2. 训练策略

### 2.1 数据处理
1. **分词策略**
   - 使用 SentencePiece 分词器
   - BPE (Byte-Pair Encoding) 算法
   - 特殊token:
     - [PAD]: 0
     - [UNK]: 1
     - [BOS]: 2
     - [EOS]: 3

2. **数据集构建**
   - 动态生成训练样本
   - 支持可变长度输入
   - 自动添加开始和结束标记
   - 使用注意力掩码处理填充

### 2.2 优化方法
1. **优化器**
   - AdamW优化器
   - 权重衰减: 0.01
   - β1 = 0.9, β2 = 0.999

2. **学习率调度**
   - 线性预热
   - 余弦衰减
   - 预热步数: 1000
   - 初始学习率: 3e-4

3. **正则化**
   - Dropout: 0.1
   - 梯度裁剪: 1.0
   - 权重衰减

### 2.3 训练流程
1. **批次处理**
   - 动态批次大小
   - tiny: 32-64
   - small: 16-32
   - medium: 8-16

2. **验证策略**
   - 每个epoch验证
   - 保存最佳模型
   - 早停机制

3. **监控指标**
   - 训练损失
   - 验证损失
   - 学习率变化
   - 梯度范数
   - 生成样本质量

## 3. 推理优化

### 3.1 生成策略
1. **采样方法**
   - Temperature sampling
   - Top-k sampling
   - Top-p (nucleus) sampling
   - 组合采样策略

2. **生成控制**
   - 最大长度限制
   - 结束符检测
   - 重复惩罚

### 3.2 性能优化
1. **推理加速**
   - KV缓存
   - 批量生成
   - 注意力掩码优化

2. **内存优化**
   - 梯度检查点
   - 混合精度训练
   - 模型量化

## 4. 模型规格

### 4.1 Tiny版本
- 词表大小: 10,000
- 模型维度: 128
- 注意力头数: 2
- 层数: 2
- 参数量: ~5M
- 适用场景: 快速实验和测试

### 4.2 Small版本
- 词表大小: 30,000
- 模型维度: 256
- 注意力头数: 4
- 层数: 4
- 参数量: ~20M
- 适用场景: 一般应用

### 4.3 Medium版本
- 词表大小: 50,000
- 模型维度: 512
- 注意力头数: 8
- 层数: 6
- 参数量: ~100M
- 适用场景: 高质量生成

## 5. 训练建议

### 5.1 硬件要求
1. **最小配置**
   - GPU: 8GB显存
   - RAM: 16GB
   - 存储: 20GB

2. **推荐配置**
   - GPU: 16GB显存
   - RAM: 32GB
   - 存储: 50GB

### 5.2 训练技巧
1. **内存管理**
   - 根据显存调整批次大小
   - 使用梯度累积
   - 启用混合精度训练

2. **稳定性提升**
   - 渐进式增加序列长度
   - 适当调整预热步数
   - 监控梯度变化

3. **效果优化**
   - 数据质量把控
   - 超参数调优
   - 模型集成

## 6. 常见问题

### 6.1 训练问题
1. **损失不收敛**
   - 检查学习率设置
   - 验证数据预处理
   - 调整模型配置

2. **显存溢出**
   - 减小批次大小
   - 启用梯度检查点
   - 使用混合精度训练

3. **生成质量差**
   - 增加训练轮数
   - 调整采样参数
   - 优化数据质量

### 6.2 推理问题
1. **生成速度慢**
   - 使用KV缓存
   - 批量处理请求
   - 模型量化

2. **重复生成**
   - 调整采样温度
   - 使用重复惩罚
   - 优化结束条件 